 <p>新浪微博：<a href="http://weibo.com/johntech" rel="nofollow">http://weibo.com/johntech</a> </p><p>twitter: <a href="http://twitter.com/zhoukunta" rel="nofollow">http://twitter.com/zhoukunta</a> </p><p>myblog </p><p><a href="https://github.com/johntech-o/blog" rel="nofollow">https://github.com/johntech-o/blog</a> </p><p>qq群(3):148407254  qq群(1) 37499077(已满)  qq群(2)：118437809（已满） </p><h1><a name="Introduce"></a>Introduce<a href="#Introduce" class="section_anchor"></a></h1><p><strong>  </strong></p><blockquote><strong>sersync主要用于服务器同步，web镜像等功能。基于boost1.43.0,inotify api,rsync command.开发。目前使用的比较多的同步解决方案是inotify-tools+rsync ，另外一个是google开源项目Openduckbill（依赖于inotify- tools），这两个都是基于脚本语言编写的。相比较上面两个项目，本项目优点是：</strong> 
</blockquote><ol><li>sersync是使用c++编写，而且对linux系统文件系统产生的临时文件和重复的文件操作进行过滤（详细见附录，这个过滤脚本程序没有实现），所以在结合rsync同步的时候，节省了运行时耗和网络资源。因此更快。 </li><li>相比较上面两个项目，sersync配置起来很简单，其中bin目录下已经有基本上静态编译的2进制文件，配合bin目录下的xml配置文件直接使用即可。 </li><li>另外本项目相比较其他脚本开源项目，使用多线程进行同步，尤其在同步较大文件时，能够保证多个服务器实时保持同步状态。 </li><li>本项目有出错处理机制，通过失败队列对出错的文件重新同步，如果仍旧失败，则按设定时长对同步失败的文件重新同步。 </li><li>本项目自带crontab功能，只需在xml配置文件中开启，即可按您的要求，隔一段时间整体同步一次。无需再额外配置crontab功能。 </li><li>本项目socket与http插件扩展，满足您二次开发的需要。 </li></ol><p></p><p>      </p><blockquote>欢迎参与讨论，持续更新中.thank you! 
</blockquote><blockquote>感谢 xoyo 组长宴哥(s135)和 好友吴浩(terry),对本项目开发过程中的指导与帮助。 
</blockquote><p>         <strong>最新中文安装配置说明见</strong>： </p><blockquote><a href="http://blog.johntechinfo.com/sersyncguild" rel="nofollow">最新Sersync中文使用指南</a> 
</blockquote><p></p><blockquote><a href="http://hi.baidu.com/johntech/blog/item/f8bdaec8fb3c268dc81768c0.html" rel="nofollow">Sersync服务器同步程序----使用指南list</a> 
</blockquote><p><strong>各版本bug修改与功能更新历史记录</strong>: </p><p>非常用的文件系统如xfs或者reiserfs，如果不能递归监控子目录，或开启sersync已经存在的目录，请将配置文件中的xfs设置为start </p><p><a href="http://code.google.com/p/sersync/wiki/NewReleaseFeature" rel="nofollow">http://code.google.com/p/sersync/wiki/NewReleaseFeature</a> </p><hr><p><strong>  </strong></p><blockquote><strong>sersync is mainly used in server synchronization and web mirroring, developed Base on boost1.41.0, inotify api, rsync command. Currently, common synchronous solutions  use inotify-tools + rsync,or use google open source project Openduckbill (depends on inotify-tools), which are both written in script languages. Compared to the above two projects, this project has following benefits : </strong> 
</blockquote><ol><li>Sersync is developed by c ++, it can filter lots of  temporary files and duplicated inotify events generated by linux file system(for details see the appendix, the filter function is difficult for script program to implement),so it can save more time and  network resources.  </li><li>Compare the above two projects, sersync is easy to use.You can use the binary executable file and the xml configuration file directly,both of them are in the bin directory. </li><li>Compared to other script programs,sersync uses multiple threads to synchronize , especially used in synchronizing  large files, it can ensure multiple servers  to keep synchronization in real-time. </li><li>The project has an error handling mechanism,add all the failed event to failure queue and try again, if still fails, sersync will retry every 10 hours until it is successfully synchronized . </li><li>The project has crontab function.using the xml configuration file, you can according to your requirements,  sync the whole monitor directory from time to time.  </li><li>The project has socket and http plugin extensions which can meet your secondary development needs.  </li></ol><p></p><h1><a name="Design_Frame"></a>Design Frame<a href="#Design_Frame" class="section_anchor"></a></h1><blockquote><img src="http://www.ppseek.com/shareimg/1519585.jpg"> 
</blockquote><h1><a name="Compile"></a>Compile<a href="#Compile" class="section_anchor"></a></h1><hr><p>if you are using linux, under normal circumstances, do not need to compile, directly use the executable file and the xml configuration file under the bin directory  </p><p>src directory: the source files. </p><p>include directory: the boost head files(1.41.0). </p><p>lib directory: static libraries. </p><p>bin directory: binary  executable file and xml configuration file. </p><p>You can execute make command in sersync directory which will generate  binary file into the bin directory. </p><h1><a name="Install"></a>Install<a href="#Install" class="section_anchor"></a></h1><h2><a name="Config_Rsync_before_install"></a>Config Rsync before install<a href="#Config_Rsync_before_install" class="section_anchor"></a></h2><p>Before use, you need to  config rsync and open the rsync daemon on each server. Normally configured as follows: </p><pre class="prettyprint"><span class="pln">vi &nbsp;</span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">rsyncd</span><span class="pun">.</span><span class="pln">conf</span></pre><pre class="prettyprint"><span class="pln">uid</span><span class="pun">=</span><span class="pln">root<br>gid</span><span class="pun">=</span><span class="pln">root<br>max connections</span><span class="pun">=</span><span class="lit">36000</span><span class="pln"><br></span><span class="kwd">use</span><span class="pln"> chroot</span><span class="pun">=</span><span class="kwd">no</span><span class="pln"><br>log file</span><span class="pun">=</span><span class="str">/var/</span><span class="pln">log</span><span class="pun">/</span><span class="pln">rsyncd</span><span class="pun">.</span><span class="pln">log<br>pid file</span><span class="pun">=</span><span class="str">/var/</span><span class="pln">run</span><span class="pun">/</span><span class="pln">rsyncd</span><span class="pun">.</span><span class="pln">pid<br></span><span class="kwd">lock</span><span class="pln"> file</span><span class="pun">=</span><span class="str">/var/</span><span class="pln">run</span><span class="pun">/</span><span class="pln">rsyncd</span><span class="pun">.</span><span class="kwd">lock</span><span class="pln"><br><br><br></span><span class="pun">【</span><span class="pln">tongbu</span><span class="pun">】</span><span class="pln"><br>path</span><span class="pun">=</span><span class="str">/opt/</span><span class="pln">tongbu<br>comment </span><span class="pun">=</span><span class="pln"> xoyo video files<br>ignore errors </span><span class="pun">=</span><span class="pln"> yes<br>read only </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">no</span><span class="pln"><br>hosts allow </span><span class="pun">=</span><span class="pln"> </span><span class="lit">192.168</span><span class="pun">.</span><span class="lit">8.40</span><span class="pun">/</span><span class="lit">26</span><span class="pln"> </span><span class="lit">192.168</span><span class="pun">.</span><span class="lit">138.94</span><span class="pun">/</span><span class="lit">24</span><span class="pln"><br>hosts deny </span><span class="pun">=</span><span class="pln"> </span><span class="pun">*</span></pre><p>Configuration parameters, please google. </p><p>Then open  rsync daemon on each server: </p><pre class="prettyprint"><span class="pln">rsync </span><span class="pun">--</span><span class="pln">daemon</span></pre><h2><a name="Install_sersync"></a>Install sersync<a href="#Install_sersync" class="section_anchor"></a></h2><p>Since most libraries are statically compiled, after modifying the  configuration file, you can directly execute ./sersync2.1 on the server being monitored. </p><pre class="prettyprint"><span class="pln">tar zxvf sersync2</span><span class="pun">.</span><span class="lit">1.tar</span><span class="pun">.</span><span class="pln">gz<br><br>cd sersync</span></pre><p>before using , write the xml configuration file </p><pre class="prettyprint"><span class="pln">vi confxml</span><span class="pun">.</span><span class="pln">xml</span></pre><p>According to the use of different plug-ins and features you need to modify the different parts of the configuration file as follows: </p><h3><a name="synchronization_funciton_config"></a>synchronization funciton config<a href="#synchronization_funciton_config" class="section_anchor"></a></h3><p>Just modify the sersync tab as follows: </p><pre class="prettyprint"><span class="pln">&nbsp;</span><span class="tag">&lt;sersync&gt;</span><span class="pln"><br><br>&nbsp; </span><span class="tag">&lt;localpath</span><span class="pln"> </span><span class="atn">watch</span><span class="pun">=</span><span class="atv">"/opt/tongbu"</span><span class="tag">&gt;</span><span class="pln"><br><br>&nbsp; &nbsp;</span><span class="tag">&lt;remote</span><span class="pln"> </span><span class="atn">ip</span><span class="pun">=</span><span class="atv">"192.168.8.42"</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"tongbu"</span><span class="tag">/&gt;</span><span class="pln"><br><br>&nbsp; &nbsp;</span><span class="tag">&lt;remote</span><span class="pln"> </span><span class="atn">ip</span><span class="pun">=</span><span class="atv">"192.168.8.39"</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"tongbu"</span><span class="tag">/&gt;</span><span class="pln"><br><br>&nbsp; </span><span class="tag">&lt;/localpath&gt;</span><span class="pln"><br><br>&nbsp; </span><span class="tag">&lt;crontab</span><span class="pln"> </span><span class="atn">start</span><span class="pun">=</span><span class="atv">"true"</span><span class="pln"> </span><span class="atn">schedule</span><span class="pun">=</span><span class="atv">"30"</span><span class="tag">/&gt;</span><span class="pln"><br><br>&nbsp; </span><span class="tag">&lt;plugin</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"refreshCDN"</span><span class="pln"> </span><span class="atn">start</span><span class="pun">=</span><span class="atv">"true"</span><span class="tag">/&gt;</span><span class="pln"><br><br>&nbsp;</span><span class="tag">&lt;/sersync&gt;</span></pre><p>the watch attribute of localpath tag identify the local path which required synchronization, remote tag need to fill in the remote host ip and rsync module name. if set the crontab tag's start label to true, the crontab will work. you can set the schedule properties to formulate how many minutes to synchronize the monitor directory wholly once. </p><h1><a name="execute"></a>execute<a href="#execute" class="section_anchor"></a></h1><h2><a name="synchronize_or_synchronize_+_plugin"></a>synchronize or synchronize + plugin<a href="#synchronize_or_synchronize_+_plugin" class="section_anchor"></a></h2><pre class="prettyprint"><span class="pun">./</span><span class="pln">sersync2</span><span class="pun">.</span><span class="lit">1</span><span class="pln"> </span><span class="pun">-</span><span class="pln">h </span></pre><p>before the   synchronization program working, rsync the whole monitor directory to remote server once </p><pre class="prettyprint"><span class="pun">./</span><span class="pln">sersync2</span><span class="pun">.</span><span class="lit">1</span><span class="pln"> </span><span class="pun">-</span><span class="pln">r </span></pre><p>Open the daemon mode, running in the background </p><pre class="prettyprint"><span class="pun">./</span><span class="pln">sersync2</span><span class="pun">.</span><span class="lit">1</span><span class="pln"> </span><span class="pun">-</span><span class="pln">d</span></pre><p>'-o xxxxx.xml'(Specify the configuration file name, if the configuration file name is not confxml.xml use the '-o xxxxx.xml') </p><pre class="prettyprint"><span class="pun">./</span><span class="pln">sersync2</span><span class="pun">.</span><span class="lit">1</span><span class="pln"> </span><span class="pun">-</span><span class="pln">o</span></pre><p>Specify the number of simultaneous daemon thread, the default is 10, applicable to the present four-core server. If you need to increase or reduce,please use  './sersync2.1 -n + num' to run </p><pre class="prettyprint"><span class="pun">./</span><span class="pln">sersync2</span><span class="pun">.</span><span class="lit">1</span><span class="pln"> </span><span class="pun">-</span><span class="pln">n</span></pre><p>Commonly use following command to execute: </p><pre class="prettyprint"><span class="pun">./</span><span class="pln">sersync2</span><span class="pun">.</span><span class="lit">1</span><span class="pln"> </span><span class="pun">-</span><span class="pln">d </span><span class="pun">-</span><span class="pln">r</span></pre><h2><a name="plugin_config"></a>plugin config<a href="#plugin_config" class="section_anchor"></a></h2><hr><p>refresh CDN plugin config： </p><p>this plugin is designed according to chinaCDN protocol , when there are inotify event arise, will send to china cdn the transfored path information.refreshCDN plugin need config the xml as follows: </p><pre class="prettyprint"><span class="pln">&nbsp;</span><span class="tag">&lt;plugin</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"refreshCDN"</span><span class="tag">&gt;</span><span class="pln"><br><br>- </span><span class="tag">&lt;localpath</span><span class="pln"> </span><span class="atn">watch</span><span class="pun">=</span><span class="atv">"/data0/htdocs/cms.xoyo.com/site/"</span><span class="tag">&gt;</span><span class="pln"><br><br>&nbsp;</span><span class="tag">&lt;cdninfo</span><span class="pln"> </span><span class="atn">domainname</span><span class="pun">=</span><span class="atv">"ccms.chinacache.com"</span><span class="pln"> </span><span class="atn">port</span><span class="pun">=</span><span class="atv">"80"</span><span class="pln"> </span><span class="atn">username</span><span class="pun">=</span><span class="atv">"yourname"</span><span class="pln"> </span><span class="atn">passwd</span><span class="pun">=</span><span class="atv">"yourpasswd"</span><span class="pln"> </span><span class="tag">/&gt;</span><span class="pln"> <br><br>&nbsp;</span><span class="tag">&lt;sendurl</span><span class="pln"> </span><span class="atn">base</span><span class="pun">=</span><span class="atv">"http://pic.xoyo.com/cms"</span><span class="pln"> </span><span class="tag">/&gt;</span><span class="pln"> <br><br>&nbsp;</span><span class="tag">&lt;regexurl</span><span class="pln"> </span><span class="atn">regex</span><span class="pun">=</span><span class="atv">"false"</span><span class="pln"> </span><span class="atn">match</span><span class="pun">=</span><span class="atv">"cms.xoyo.com/site([/a-zA-Z0-9]*).xoyo.com/images"</span><span class="pln"> </span><span class="tag">/&gt;</span><span class="pln"> <br><br>&nbsp;</span><span class="tag">&lt;/localpath&gt;</span><span class="pln"><br><br>&nbsp;</span><span class="tag">&lt;/plugin&gt;</span></pre><p>As shown in the above xml, where plugin tag is used to  call plug-ins,during the synchronization . Currently using refresh cdn plug-in "refreshCDN",  </p><pre class="prettyprint"><span class="pln">&nbsp; </span><span class="tag">&lt;plugin</span><span class="pln"> </span><span class="atn">name</span><span class="pun">=</span><span class="atv">"refreshCDN"</span><span class="pln"> </span><span class="atn">start</span><span class="pun">=</span><span class="atv">"true"</span><span class="tag">/&gt;</span></pre><p>that is, during the synchronization process, after synchronize the file to the remote server, will call refreshCDN plugin to refresh the china CDN(transform inotify event to china cdn interface protocol). If you do not want to use plugin function, set start attribute to false. If you need to use other plug-ins, see other plugin labels, change the plugin name to other plugin tag name,like socket or http. There are currently supports three plug-ins refreshCDN socket http. socket plug-in is to  send inotify events to specify ip and port, http plug-in is to send (post) Inotify event to the specified domain name. </p><p>the watch attribute of localpath  tag is the path being monitored,this will overlap the localpath tag in the sersync.  </p><p>cdnifo tag specify the china cdn interface domain,port number,username and password,which are needed by china cdn. </p><p>sendurl tag is the url prefix </p><p>in the regexurl tag，if "regex" attribute is true，use the string in the "match" attribute to regular match the path send by inotify，use the string matched  as part of the url which will be sent to china cdn. </p><p>for example，if inotify event is : </p><p>/data0/htdoc/cms.xoyo.com/site/jx3.xoyo.com/image/a/123.txt </p><p>after regular match, the path to send to cdn interface is : </p><p><tt>http://pic.xoyo.com/cms/jx3/a/123.txt</tt>; </p><p>if regex attribute is set to false ,the path send to cdn interface is: </p><p><tt>http://pic.xoyo.com/cms/jx3.xoyo.com/images/a/123.txt</tt>; </p><p>socket and http plugin is very simple，just specify the info in the xml. </p><h2><a name="run_the_plugin_Only"></a>run the plugin Only<a href="#run_the_plugin_Only" class="section_anchor"></a></h2><p>when the inotify event arrive, you can run the plugin only, in this way ,the synchronization will not work.execute as follows: </p><p>run refresh cdn plugin only : </p><pre class="prettyprint"><span class="pun">./</span><span class="pln">sersync2</span><span class="pun">.</span><span class="lit">1</span><span class="pln"> </span><span class="pun">-</span><span class="pln">d &nbsp;</span><span class="pun">-</span><span class="pln">m &nbsp;refreshCDN</span></pre><p>run socket plugin only: </p><pre class="prettyprint"><span class="pun">./</span><span class="pln">sersync2</span><span class="pun">.</span><span class="lit">1</span><span class="pln"> &nbsp;</span><span class="pun">-</span><span class="pln">d </span><span class="pun">-</span><span class="pln">m socket</span></pre><p>run Http plugin only </p><pre class="prettyprint"><span class="pun">./</span><span class="pln">sersync2</span><span class="pun">.</span><span class="lit">1</span><span class="pln"> </span><span class="pun">-</span><span class="pln">d </span><span class="pun">-</span><span class="pln">m http</span></pre><h1><a name="log_file_description"></a>log file description<a href="#log_file_description" class="section_anchor"></a></h1><blockquote>In the implementation process, will produce rsync_fail_log.sh files, which record the file fail to rsync,the rsync_fail_log.sh will execute every 10 hours,and will be cleared after executed.If you call refresh cdn plugin, the implementation process will produce error.log file, records the information received from the cdn, and record the  path refreshed. 
</blockquote><h1><a name="appendix"></a>appendix<a href="#appendix" class="section_anchor"></a></h1><p>the script program can not filter the inotify event that we don't use. if we vi a file "test",will generate inotify events as follows: </p><blockquote><img src="http://johntech-resource.googlecode.com/files/9659c0efd6866a7d79f055dd.jpg.png"> 
</blockquote>in my progam ,only add one event to the queue after the filter,so it can save lots of synchronization time and network resource. detail info see the blog: <blockquote><a href="http://hi.baidu.com/johntech/blog/item/e4a31a3db1ee1ce755e723f4.html" rel="nofollow">http://hi.baidu.com/johntech/blog/item/e4a31a3db1ee1ce755e723f4.html</a> 
</blockquote><p></p><p>为什么脚本监控效率低? 因为脚本监控，即使使用--exclude正则语法也无法过滤掉一些文件系统产生的临时文件和临时事件， 造成rsync反复执行，详细文章如下: </p><p><a href="http://hi.baidu.com/johntech/blog/item/e4a31a3db1ee1ce755e723f4.html" rel="nofollow">http://hi.baidu.com/johntech/blog/item/e4a31a3db1ee1ce755e723f4.html</a> </p>
